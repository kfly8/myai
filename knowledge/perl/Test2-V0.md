# Test2::V0 チートシート

Test2::V0は、Test2エコシステムの主要コンポーネントをまとめたバンドルモジュールです。
本チートシートでは、特に`Test2::Tools::Compare`モジュールのmatchersに焦点を当てて説明します。

## 基本的な使い方

```perl
use Test2::V0;  # pragmaとして strict, warnings, utf8 が有効になります

# 基本的なテスト
ok(1, "テストが成功しました");
is($got, $expected, "値が期待通りです");

done_testing;  # テストの終了
```

## Test2::Tools::Compare Matchers

### 基本的な比較

#### 厳密な比較 (`is`/`isnt`)

`is()`は厳密な比較を行います。ハッシュのすべてのフィールド、配列のすべての要素が完全に一致する必要があります。

```perl
# 値が完全に一致するか確認
is($got, $expected, "値が期待通りです");

# 値が一致しないことを確認
isnt($got, $not_expected, "値が期待と異なります");
```

#### 緩い比較 (`like`/`unlike`)

`like()`は緩い比較を行います。指定したフィールドや要素のみをチェックし、正規表現も使用できます。

```perl
# ハッシュの一部のキーのみチェック
like(
    $hash,
    { name => 'John', age => qr/^\d+$/ },
    "名前がJohnで、年齢が数字のみです"
);

# 値がパターンに一致しないことを確認
unlike($got, qr/error/, "エラーメッセージが含まれていません");
```

### 型チェック（Quick Checks）

```perl
# 真の値かチェック
is($value, T(), "値は真です");

# 偽の値かチェック（存在している必要あり）
is($value, F(), "値は偽です");

# 定義されているかチェック
is($value, D(), "値は定義されています");

# 未定義かチェック
is($value, U(), "値は未定義です");

# 定義されていて偽かチェック
is($value, DF(), "値は定義されていて偽です");

# 存在するかチェック
is($array, array { item 2 => E() }, "配列の3番目の要素が存在します");

# 存在しないかチェック
is($hash, hash { field missing => DNE() }, "missingキーは存在しません");

# 偽または存在しないかチェック
is($value, FDNE(), "値は偽か存在しません");

# 長さがあるかチェック（定義されていて空文字列でない）
is($value, L(), "値は長さがあります");
```

### 値のチェック

```perl
# 文字列との比較
is($string, string("hello"), "文字列がhelloです");

# 数値との比較
is($number, number(42), "数値が42です");

# 数値の範囲チェック
is($number, within(10, 0.5), "数値が9.5から10.5の範囲内です");

# 丸めた数値の比較
is($float, rounded(3.14159, 2), "小数点以下2桁で3.14に丸められます");

# 真偽値チェック
is($value, bool(1), "真偽値が真です");

# クラスのインスタンスかチェック
is($object, check_isa("My::Class"), "My::Classのインスタンスです");
```

### 正規表現マッチング

```perl
# 値が正規表現にマッチするか（stringifyされる）
is($value, match(qr/pattern/), "パターンにマッチします");

# 値が正規表現にマッチしないか
is($value, mismatch(qr/pattern/), "パターンにマッチしません");
```

### カスタムバリデーション

```perl
# カスタム検証ロジック
is(
    $value,
    validator(sub {
        my %params = @_;
        my $got = $params{got};
        return $got > 0 && $got < 100;
    }),
    "値は0より大きく100未満です"
);
```

### ハッシュ検証

```perl
# ハッシュ構造の検証
is(
    $hash,
    hash {
        # 特定のフィールドをチェック
        field name => 'John';
        field age => number(30);
        
        # 存在しないフィールドをチェック
        field deleted => DNE();
        
        # 正規表現でチェック
        field email => match(qr/@/);
        
        # すべての値に適用されるチェック
        all_vals match(qr/\S/);  # すべての値が空白でない
        
        # すべてのキーに適用されるチェック
        all_keys match(qr/^[a-z_]+$/);  # すべてのキーが小文字またはアンダースコア
        
        # 他のキーが存在しないことを確認
        end();
        
        # または、他のキーを無視する
        # etc();
    },
    "ハッシュ構造が正しいです"
);
```

### 配列検証

```perl
# 配列構造の検証
is(
    $array,
    array {
        # インデックス0の要素をチェック
        item 'first';
        
        # インデックス1の要素をチェック
        item 'second';
        
        # 特定のインデックスをチェック
        item 4 => 'fifth';
        
        # すべての要素に適用されるチェック
        all_items match(qr/\S/);  # すべての要素が空白でない
        
        # フィルタリング（残りの要素から数字を含む要素を削除）
        filter_items { grep { !m/[0-9]/ } @_ };
        
        # 他の要素が存在しないことを確認
        end();
        
        # または、他の要素を無視する
        # etc();
    },
    "配列構造が正しいです"
);
```

### バッグ検証（順序を気にしない配列）

```perl
# 順序を気にせず配列の要素をチェック
is(
    $array,
    bag {
        item 'apple';
        item 'banana';
        item 'orange';
        
        # 他の要素が存在しないことを確認
        end();
    },
    "配列には指定した要素のみが含まれています（順序は問わない）"
);
```

### 順序付きサブセット検証

```perl
# 配列のサブセットをチェック（順序あり、他の要素があってもOK）
is(
    $array,
    subset {
        item 'first';
        item 'second';
        # 間に他の要素があってもOK
        item 'last';
    },
    "配列には指定した要素が順序通りに含まれています"
);
```

### オブジェクト検証

```perl
# オブジェクトの検証
is(
    $object,
    object {
        # メソッド呼び出しの結果をチェック
        call name => 'John';
        call age => number(30);
        
        # 存在しないメソッドをチェック
        call missing_method => DNE();
        
        # 複数の戻り値を持つメソッドをチェック
        call_list get_items => ['item1', 'item2'];
        
        # ハッシュを返すメソッドをチェック
        call_hash get_properties => { color => 'red', size => 'large' };
        
        # オブジェクトのプロパティをチェック
        prop blessed => 'My::Class';  # blessされたパッケージ
        prop isa => 'My::BaseClass';  # 継承しているクラス
    },
    "オブジェクトが正しい構造です"
);
```

### メタ検証

```perl
# リファレンスのメタプロパティをチェック
is(
    $ref,
    meta {
        prop blessed => 'My::Module';  # blessされたパッケージ
        prop reftype => 'HASH';        # リファレンスタイプ
        prop isa => 'My::Base';        # 継承しているクラス
        prop size => 4;                # ハッシュキーまたは配列要素の数
    },
    "リファレンスのメタプロパティが正しいです"
);
```

### セット検証

```perl
# 値が指定したチェックのいずれかに一致するか
is($value, in_set(1, 2, 3, qr/^\d+$/), "値は1, 2, 3のいずれか、または数字のみです");

# 値が指定したチェックのいずれにも一致しないか
is($value, not_in_set(1, 2, 3), "値は1, 2, 3のいずれでもありません");

# 値が指定したすべてのチェックに一致するか
is($value, check_set(D(), match(qr/^\d+$/), number(42)), "値は定義済みで、数字のみで、42です");
```

## 一般的なユースケースとベストプラクティス

| ユースケース | 推奨されるMatcher | 備考 |
|------------|-----------------|------|
| 単純な値の比較 | `is()` | 厳密な比較が必要な場合 |
| パターンマッチング | `like()` | 正規表現や部分的なチェックが必要な場合 |
| NULLチェック | `is($val, U())` | 未定義値をチェック |
| 真偽値チェック | `is($val, T())` または `is($val, F())` | 値の真偽をチェック |
| オブジェクトの型チェック | `is($obj, check_isa("Class"))` | クラスのインスタンスかチェック |
| 複雑なデータ構造チェック | `hash {}`、`array {}`、`object {}` | 階層的なデータ構造の詳細チェック |
| 順序を気にしないリスト比較 | `bag {}` | 要素の順序が重要でない場合 |
| 数値の近似比較 | `within()` または `rounded()` | 浮動小数点比較の場合 |
| カスタム検証ロジック | `validator(sub { ... })` | 複雑な条件でチェックする場合 |

## 注意点と Tips

1. `is()`と`like()`の使い分け
   - `is()`：完全一致が必要な場合
   - `like()`：部分的な一致や正規表現での比較が必要な場合

2. `F()`と`DNE()`の違い
   - `F()`：値が存在し、偽であること
   - `DNE()`：値が存在しないこと
   - `FDNE()`：値が偽であるか存在しないこと

3. ハッシュや配列の検証に`end()`と`etc()`
   - `end()`：余分なキーや要素がないことを確認
   - `etc()`：余分なキーや要素を無視

4. テストの記述スタイル
   - ハッシュや配列のビルダーを使うと、エラーが発生した場合により詳細な情報が得られます
   - `field`や`item`を使うと、どの値がテスト失敗の原因かを特定しやすくなります

5. 環境変数で挙動制御
   - `T2_AUTO_DUMP=1`：テスト失敗時に`$got`の内容をData::Dumperでダンプ
   - `T2_AUTO_DEPARSE=1`：コードリファレンスをData::Dumperでデパース
